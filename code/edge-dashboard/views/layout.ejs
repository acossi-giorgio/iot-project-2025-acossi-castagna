<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title><%= pageTitle %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://unpkg.com/chart.js@4.4.4/dist/chart.umd.js"
      defer
    ></script>
    <link rel="stylesheet" href="/public/css/styles.css" />
  </head>
  <body
    class="bg-body-tertiary <%= pageTitle && pageTitle.toLowerCase().includes('chat') ? 'page-chat' : '' %>"
  >
    <% if (!hideDock) { %>
    <script>
      (function () {
        const id = localStorage.getItem("sessionId");
        if (!id) {
          if (!location.pathname.startsWith("/session"))
            location.replace("/session");
          return;
        }
        if (!location.search.includes("sessionId=")) {
          const u = new URL(location.href);
          u.searchParams.set("sessionId", id);
          location.replace(u.toString());
        }
      })();
    </script>
    <% } %> <% if (!hideDock) { %>
    <div
      class="d-flex"
      style="min-height: 100vh; scrollbar-gutter: stable both-edges"
    >
      <nav class="app-sidebar d-flex flex-column bg-white border-end shadow-sm">
        <div class="nav flex-column py-2">
          <a
            href="/dashboard<% if (typeof sessionId !== 'undefined') { %>?sessionId=<%= sessionId %><% } %><% if (typeof offline !== 'undefined' && offline) { %>&offline=true<% } %>"
            class="nav-link px-3 py-2 d-flex align-items-center gap-2 sidebar-link <%= pageTitle && pageTitle.toLowerCase().includes('dashboard') ? 'text-dark fw-semibold active' : 'text-secondary' %>"
          >
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path
                d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"
                fill="currentColor"
              />
            </svg>
            <span>Dashboard</span>
          </a>
          <a
            href="/chat<% if (typeof sessionId !== 'undefined') { %>?sessionId=<%= sessionId %><% } %><% if (typeof offline !== 'undefined' && offline) { %>&offline=true<% } %>"
            class="nav-link px-3 py-2 d-flex align-items-center gap-2 sidebar-link <%= pageTitle && pageTitle.toLowerCase().includes('chat') ? 'text-dark fw-semibold active' : 'text-secondary' %> <%= (typeof offline !== 'undefined' && offline) ? 'disabled opacity-50' : '' %>"
            <% if (typeof offline !== 'undefined' && offline) { %>aria-disabled="true" tabindex="-1"<% } %>
          >
            <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M4 4h16v12H7l-3 3V4z" fill="currentColor" />
            </svg>
            <span>Chat</span>
          </a>
        </div>
        <div class="mt-auto p-3">
          <button
            id="end-session-btn"
            class="btn btn-outline-danger w-100 d-flex align-items-center gap-2 justify-content-center"
          >
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path
                d="M18.3 5.71 12 12l6.3 6.29-1.42 1.42L10.59 13.4 4.29 19.7 2.87 18.3 9.17 12 2.87 5.71 4.29 4.29l6.3 6.3 6.29-6.3 1.42 1.42Z"
                fill="currentColor"
              />
            </svg>
            <span>Close</span>
          </button>
        </div>
      </nav>
      <main
        class="flex-grow-1 p-2 d-flex flex-column"
        style="min-width: 0; min-height: 0"
      >
        <div
          class="flex-grow-1 d-flex flex-column"
          id="page-root"
          style="min-height: 0"
        >
          <%- body %>
        </div>
      </main>
    </div>
  <script>
      (function () {
    const btn = document.getElementById("end-session-btn");

    // Funzione che chiude la sessione come il bottone
    async function closeSession(id) {
      try {
        if (id) {
          const r = await fetch(`/api/session/${encodeURIComponent(id)}`, {
            method: "DELETE",
          });
          if (!r.ok) throw new Error("Chiusura sessione fallita");
        }
      } catch (e) {
        window.IoTToasts?.show(e.message || "Errore chiusura sessione", {
          variant: "danger",
          delay: 4000,
        });
      } finally {
        localStorage.removeItem("sessionId");
        window.location.replace("/session");
      }
    }

    // Chiusura manuale sessione
    btn?.addEventListener("click", async () => {
      const id = localStorage.getItem("sessionId");
      await closeSession(id);
    });

    // Controllo automatico sessione
    const checkInterval = 5000; // ogni 5 secondi
    async function checkSession() {
      const id = localStorage.getItem("sessionId");
      if (!id) return;

      try {
        const res = await fetch(`/api/session/${encodeURIComponent(id)}`);
        if (!res.ok) {
          // chiusura automatica completa
          await fetch(`/api/session/${encodeURIComponent(id)}`, { method: "DELETE" });
          localStorage.removeItem("sessionId");
          window.IoTToasts?.show("Session expired", { variant: "warning", delay: 3000 });
          setTimeout(() => window.location.replace("/session"), 1000);
        }
      } catch (e) {
        console.error("Errore controllo sessione", e);
      }
    }
    setInterval(checkSession, checkInterval);

    })();

  </script>

    <% } else { %>
    <main class="container-fluid vh-100"><%- body %></main>
    <% } %>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
  </body>
  <div
    class="position-fixed top-0 end-0 p-3 d-flex flex-column align-items-end"
    style="z-index: 1080; gap: 0.5rem"
    id="toast-container"
  ></div>
  <script defer>
    window.IoTToasts = (function () {
      function show(message, { variant = "danger", delay = 4000 } = {}) {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const id = "t" + Date.now() + Math.random().toString(36).slice(2, 7);
        const el = document.createElement("div");
        el.className = `toast align-items-center text-bg-${variant} border-0 show mb-1 shadow`;
        el.setAttribute("role", "alert");
        el.setAttribute("aria-live", "assertive");
        el.setAttribute("aria-atomic", "true");
        el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div></div>`;
        container.appendChild(el);
        setTimeout(() => {
          try {
            el.classList.remove("show");
            el.classList.add("hide");
            setTimeout(() => el.remove(), 450);
          } catch {}
        }, delay);
        return id;
      }
      return { show };
    })();
  </script>
</html>
